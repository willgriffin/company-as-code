#!/usr/bin/env bash
set -euo pipefail

# Get kubeconfig from Terraform output
# This script retrieves the kubeconfig for the DigitalOcean Kubernetes cluster

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TERRAFORM_DIR="${SCRIPT_DIR}/../terraform/digitalocean"

# Check if terraform directory exists
if [ ! -d "$TERRAFORM_DIR" ]; then
    echo "Error: Terraform directory not found at $TERRAFORM_DIR" >&2
    exit 1
fi

# Change to terraform directory
cd "$TERRAFORM_DIR"

# Check if terraform is initialized
if [ ! -d ".terraform" ]; then
    echo "Error: Terraform not initialized. Run 'terraform init' first." >&2
    exit 1
fi

# Get the kubeconfig output
echo "Retrieving kubeconfig from Terraform output..." >&2
terraform output -raw kubeconfig 2>/dev/null || {
    echo "Error: Failed to get kubeconfig. Make sure:" >&2
    echo "  1. You have run 'terraform apply' successfully" >&2
    echo "  2. The cluster is deployed" >&2
    echo "  3. You have the correct permissions" >&2
    exit 1
}