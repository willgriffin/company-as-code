#!/bin/bash
#
# Pre-push hook to run lint and build
#

echo "Running pre-push checks..."

# Check if we're in a workspace environment (has pnpm-workspace.yaml)
if [ -f "pnpm-workspace.yaml" ]; then
  # Run lint using pnpm workspace command
  echo "Running lint..."
  pnpm run lint
  LINT_EXIT_CODE=$?
  
  # If lint passes, run build
  if [ $LINT_EXIT_CODE -eq 0 ]; then
    echo "Running build..."
    pnpm run build
    BUILD_EXIT_CODE=$?
  fi
else
  # Fallback to npm
  echo "Running lint..."
  npm run lint
  LINT_EXIT_CODE=$?
  
  # If lint passes, run build
  if [ $LINT_EXIT_CODE -eq 0 ]; then
    echo "Running build..."
    npm run build
    BUILD_EXIT_CODE=$?
  fi
fi

# If lint fails, prevent push
if [ $LINT_EXIT_CODE -ne 0 ]; then
  echo "❌ Lint failed. Please fix the issues before pushing."
  echo "You can run 'pnpm run lint:fix' to auto-fix some issues."
  exit 1
fi

# If build fails, prevent push
if [ $BUILD_EXIT_CODE -ne 0 ]; then
  echo "❌ Build failed. Please fix the issues before pushing."
  exit 1
fi

echo "✅ Lint and build passed."
exit 0