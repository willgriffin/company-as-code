name: 'Check Repository Setup'
description: 'Validates that the repository has been properly configured from the template'
inputs:
  strict:
    description: 'Fail if any setup issues are found'
    required: false
    default: 'true'
  digitalocean-token:
    description: 'DigitalOcean API token'
    required: false
  digitalocean-spaces-access-key:
    description: 'DigitalOcean Spaces access key'
    required: false
  digitalocean-spaces-secret-key:
    description: 'DigitalOcean Spaces secret key'
    required: false
  aws-access-key-id:
    description: 'AWS access key ID'
    required: false
  aws-secret-access-key:
    description: 'AWS secret access key'
    required: false
  aws-ses-smtp-username:
    description: 'AWS SES SMTP username'
    required: false
  aws-ses-smtp-password:
    description: 'AWS SES SMTP password'
    required: false
  admin-email:
    description: 'Admin email address'
    required: false
  domain:
    description: 'Primary domain'
    required: false
  anthropic-api-key:
    description: 'Anthropic API key'
    required: false
  openai-api-key:
    description: 'OpenAI API key (optional)'
    required: false
  cohere-api-key:
    description: 'Cohere API key (optional)'
    required: false
  kubeconfig:
    description: 'Kubernetes config (set by terraform-deploy)'
    required: false
outputs:
  setup-complete:
    description: 'Whether the repository setup is complete'
    value: ${{ steps.check.outputs.setup-complete }}
  missing-items:
    description: 'List of missing setup items'
    value: ${{ steps.check.outputs.missing-items }}

runs:
  using: 'composite'
  steps:
    - name: Check repository setup
      id: check
      shell: bash
      run: |
        echo "üîç Checking repository setup status..."
        
        SETUP_COMPLETE=true
        MISSING_ITEMS=""
        
        # Check core infrastructure secrets (set during setup)
        echo "Checking core infrastructure secrets..."
        
        # Core required secrets
        if [[ -z "${{ inputs.digitalocean-token }}" ]]; then
          SETUP_COMPLETE=false
          MISSING_ITEMS="$MISSING_ITEMS- DIGITALOCEAN_TOKEN secret is missing (run ./setup-repo.sh)\n"
          echo "‚ùå DIGITALOCEAN_TOKEN secret is missing"
        else
          echo "‚úÖ DIGITALOCEAN_TOKEN secret is set"
        fi
        
        if [[ -z "${{ inputs.aws-access-key-id }}" ]]; then
          SETUP_COMPLETE=false
          MISSING_ITEMS="$MISSING_ITEMS- AWS_ACCESS_KEY_ID secret is missing (run ./setup-repo.sh)\n"
          echo "‚ùå AWS_ACCESS_KEY_ID secret is missing"
        else
          echo "‚úÖ AWS_ACCESS_KEY_ID secret is set"
        fi
        
        if [[ -z "${{ inputs.aws-secret-access-key }}" ]]; then
          SETUP_COMPLETE=false
          MISSING_ITEMS="$MISSING_ITEMS- AWS_SECRET_ACCESS_KEY secret is missing (run ./setup-repo.sh)\n"
          echo "‚ùå AWS_SECRET_ACCESS_KEY secret is missing"
        else
          echo "‚úÖ AWS_SECRET_ACCESS_KEY secret is set"
        fi
        
        if [[ -z "${{ inputs.anthropic-api-key }}" ]]; then
          SETUP_COMPLETE=false
          MISSING_ITEMS="$MISSING_ITEMS- ANTHROPIC_API_KEY secret is missing (run ./setup-repo.sh)\n"
          echo "‚ùå ANTHROPIC_API_KEY secret is missing"
        else
          echo "‚úÖ ANTHROPIC_API_KEY secret is set"
        fi
        
        # Auto-generated secrets (created by setup-repo.sh)
        echo "Checking auto-generated secrets..."
        
        if [[ -z "${{ inputs.digitalocean-spaces-access-key }}" ]]; then
          SETUP_COMPLETE=false
          MISSING_ITEMS="$MISSING_ITEMS- DIGITALOCEAN_SPACES_ACCESS_KEY secret missing (auto-generated by setup)\n"
          echo "‚ùå DIGITALOCEAN_SPACES_ACCESS_KEY secret missing"
        else
          echo "‚úÖ DIGITALOCEAN_SPACES_ACCESS_KEY secret is set"
        fi
        
        if [[ -z "${{ inputs.digitalocean-spaces-secret-key }}" ]]; then
          SETUP_COMPLETE=false
          MISSING_ITEMS="$MISSING_ITEMS- DIGITALOCEAN_SPACES_SECRET_KEY secret missing (auto-generated by setup)\n"
          echo "‚ùå DIGITALOCEAN_SPACES_SECRET_KEY secret missing"
        else
          echo "‚úÖ DIGITALOCEAN_SPACES_SECRET_KEY secret is set"
        fi
        
        if [[ -z "${{ inputs.aws-ses-smtp-username }}" ]]; then
          SETUP_COMPLETE=false
          MISSING_ITEMS="$MISSING_ITEMS- AWS_SES_SMTP_USERNAME secret missing (auto-generated by setup)\n"
          echo "‚ùå AWS_SES_SMTP_USERNAME secret missing"
        else
          echo "‚úÖ AWS_SES_SMTP_USERNAME secret is set"
        fi
        
        if [[ -z "${{ inputs.aws-ses-smtp-password }}" ]]; then
          SETUP_COMPLETE=false
          MISSING_ITEMS="$MISSING_ITEMS- AWS_SES_SMTP_PASSWORD secret missing (auto-generated by setup)\n"
          echo "‚ùå AWS_SES_SMTP_PASSWORD secret missing"
        else
          echo "‚úÖ AWS_SES_SMTP_PASSWORD secret is set"
        fi
        
        if [[ -z "${{ inputs.admin-email }}" ]]; then
          SETUP_COMPLETE=false
          MISSING_ITEMS="$MISSING_ITEMS- ADMIN_EMAIL secret missing (set by setup)\n"
          echo "‚ùå ADMIN_EMAIL secret missing"
        else
          echo "‚úÖ ADMIN_EMAIL secret is set"
        fi
        
        if [[ -z "${{ inputs.domain }}" ]]; then
          SETUP_COMPLETE=false
          MISSING_ITEMS="$MISSING_ITEMS- DOMAIN secret missing (set by setup)\n"
          echo "‚ùå DOMAIN secret missing"
        else
          echo "‚úÖ DOMAIN secret is set"
        fi
        
        # Check for required configuration files
        echo "Checking required configuration files..."
        
        REQUIRED_FILES=(
          "config.yaml"
          ".sops.yaml"
        )
        
        for file in "${REQUIRED_FILES[@]}"; do
          if [[ ! -f "$file" ]]; then
            SETUP_COMPLETE=false
            MISSING_ITEMS="$MISSING_ITEMS- Required file $file is missing\n"
            echo "‚ùå Required file $file is missing"
          else
            echo "‚úÖ Required file $file exists"
          fi
        done
        
        # Check for required GitHub secrets
        echo "Checking required GitHub secrets..."
        
        # Function to check if a secret appears to be set (GitHub doesn't expose secret values)
        # We use the fact that GitHub Actions will replace undefined secrets with empty strings
        check_secret() {
          local secret_name="$1"
          local secret_value="$2"
          
          if [[ -z "$secret_value" ]]; then
            SETUP_COMPLETE=false
            MISSING_ITEMS="$MISSING_ITEMS- GitHub secret $secret_name is not set\n"
            echo "‚ùå GitHub secret $secret_name is not set"
            return 1
          else
            echo "‚úÖ GitHub secret $secret_name appears to be set"
            return 0
          fi
        }
        
        # Required secrets for terraform-deploy workflow
        check_secret "DIGITALOCEAN_TOKEN" "${{ inputs.digitalocean-token }}"
        check_secret "DIGITALOCEAN_SPACES_ACCESS_KEY" "${{ inputs.digitalocean-spaces-access-key }}"
        check_secret "DIGITALOCEAN_SPACES_SECRET_KEY" "${{ inputs.digitalocean-spaces-secret-key }}"
        check_secret "AWS_ACCESS_KEY_ID" "${{ inputs.aws-access-key-id }}"
        check_secret "AWS_SECRET_ACCESS_KEY" "${{ inputs.aws-secret-access-key }}"
        
        # Required secrets for flux-bootstrap workflow
        check_secret "AWS_SES_SMTP_USERNAME" "${{ inputs.aws-ses-smtp-username }}"
        check_secret "AWS_SES_SMTP_PASSWORD" "${{ inputs.aws-ses-smtp-password }}"
        check_secret "ADMIN_EMAIL" "${{ inputs.admin-email }}"
        check_secret "DOMAIN" "${{ inputs.domain }}"
        
        # Required secrets for claude.yaml workflow
        check_secret "ANTHROPIC_API_KEY" "${{ inputs.anthropic-api-key }}"
        
        # Optional secrets (warn if not set)
        if [[ -z "${{ inputs.openai-api-key }}" ]]; then
          echo "‚ö†Ô∏è Optional secret OPENAI_API_KEY is not set"
        else
          echo "‚úÖ Optional secret OPENAI_API_KEY is set"
        fi
        
        if [[ -z "${{ inputs.cohere-api-key }}" ]]; then
          echo "‚ö†Ô∏è Optional secret COHERE_API_KEY is not set"
        else
          echo "‚úÖ Optional secret COHERE_API_KEY is set"
        fi
        
        # KUBECONFIG is set by terraform-deploy workflow, so we check if it exists
        if [[ -z "${{ inputs.kubeconfig }}" ]]; then
          echo "‚ÑπÔ∏è KUBECONFIG secret not yet set (will be created by terraform-deploy workflow)"
        else
          echo "‚úÖ KUBECONFIG secret is set"
        fi
        
        # Check for template-specific files that should be removed after setup
        echo "Checking for template-specific files..."
        
        TEMPLATE_FILES=(
          ".github/workflows/create-setup-issue.yml"
          "README-TEMPLATE.md"
        )
        
        for file in "${TEMPLATE_FILES[@]}"; do
          if [[ -f "$file" ]]; then
            echo "‚ÑπÔ∏è Template file $file still exists (will be cleaned up after successful deployment)"
          fi
        done
        
        # Check for obvious template placeholders that would prevent deployment
        echo "Checking for critical template placeholders..."
        
        if grep -r "CHANGEME" --include="*.yml" --include="*.yaml" --include="*.tf" . >/dev/null 2>&1; then
          SETUP_COMPLETE=false
          MISSING_ITEMS="$MISSING_ITEMS- Critical template placeholders (CHANGEME) still present\n"
          echo "‚ùå Found CHANGEME placeholders that will prevent deployment"
        else
          echo "‚úÖ No critical CHANGEME placeholders found"
        fi
        
        # Set outputs
        echo "setup-complete=$SETUP_COMPLETE" >> $GITHUB_OUTPUT
        echo -e "missing-items=$MISSING_ITEMS" >> $GITHUB_OUTPUT
        
        # Summary
        if [[ "$SETUP_COMPLETE" == "true" ]]; then
          echo "‚úÖ Repository setup is complete and ready for deployment!"
        else
          echo "‚ùå Repository setup is incomplete"
          echo -e "Missing items:\n$MISSING_ITEMS"
          echo ""
          echo "To complete setup:"
          echo "1. Ensure all required GitHub secrets are configured in Settings ‚Üí Secrets and variables ‚Üí Actions"
          echo "2. Run ./setup-repo.sh to customize configuration files"
          echo "3. Verify config.yaml and .sops.yaml have been properly configured"
          
          if [[ "${{ inputs.strict }}" == "true" ]]; then
            echo "::error::Repository setup is incomplete. Please configure all required secrets and run ./setup-repo.sh to complete setup."
            exit 1
          else
            echo "::warning::Repository setup is incomplete. Please configure all required secrets and consider running ./setup-repo.sh to complete setup."
          fi
        fi