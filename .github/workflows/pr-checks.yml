name: PR Checks

on:
  pull_request:
    branches: [ main ]

jobs:
  validate:
    name: Validate Code Quality
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v2

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'

    - name: Setup tools
      uses: ./.github/actions/setup-tools
      with:
        tools: 'actionlint'

    - name: Install dependencies
      run: bun install --frozen-lockfile

    - name: Type check
      run: bun run typecheck

    - name: Lint code
      run: bun run lint

    - name: Lint workflows
      run: actionlint

    - name: Check code formatting
      run: bun run format:check

    - name: Build project
      run: bun run build

    - name: Run tests
      run: bun run test

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v2

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'

    - name: Setup tools
      uses: ./.github/actions/setup-tools

    - name: Install dependencies
      run: bun install --frozen-lockfile

    - name: Run security audit
      run: bun pm audit || true

    - name: Check for secrets in code
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.before || 'HEAD~1' }}
        head: HEAD
        extra_args: --debug --only-verified

  manifests:
    name: Validate Manifests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup tools
      uses: ./.github/actions/setup-tools
      with:
        tools: 'yq'

    - name: Validate YAML files
      run: |
        echo "Validating all YAML files in manifests/..."
        ERROR_COUNT=0
        while IFS= read -r file; do
          if ! yq eval '.' "$file" > /dev/null 2>&1; then
            echo "Invalid YAML: $file"
            ERROR_COUNT=$((ERROR_COUNT + 1))
          fi
        done < <(find manifests/ -name '*.yaml' -type f)

        if [ "$ERROR_COUNT" -gt 0 ]; then
          echo "Found $ERROR_COUNT invalid YAML file(s)"
          exit 1
        fi
        echo "All YAML files are valid"

    - name: Check SOPS template files
      run: |
        echo "Checking SOPS secret template files..."
        MISSING_DOCS=0
        while IFS= read -r template; do
          DIR=$(dirname "$template")
          if [ ! -f "$DIR/README.md" ] && [ ! -f "$DIR/../README.md" ]; then
            echo "Warning: No README.md found near template $template"
            MISSING_DOCS=$((MISSING_DOCS + 1))
          fi
        done < <(find manifests/ -name '*.secret.template.yaml' -type f 2>/dev/null)

        if [ "$MISSING_DOCS" -gt 0 ]; then
          echo "Warning: $MISSING_DOCS template(s) lack nearby documentation"
        fi
        echo "SOPS template check complete"

    - name: Validate kustomization files
      run: |
        echo "Checking for kustomization files in manifest directories..."
        MISSING_COUNT=0
        while IFS= read -r dir; do
          YAML_COUNT=$(find "$dir" -maxdepth 1 -name '*.yaml' -not -name 'kustomization.yaml' -type f | wc -l)
          if [ "$YAML_COUNT" -gt 0 ]; then
            if [ ! -f "$dir/kustomization.yaml" ]; then
              echo "Missing kustomization.yaml in: $dir"
              MISSING_COUNT=$((MISSING_COUNT + 1))
            fi
          fi
        done < <(find manifests/ -type d)

        if [ "$MISSING_COUNT" -gt 0 ]; then
          echo "Found $MISSING_COUNT directories with YAML files but no kustomization.yaml"
          exit 1
        fi
        echo "All manifest directories have kustomization files"
