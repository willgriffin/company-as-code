name: Repository Setup from Template

on:
  create:
  push:
    branches: [main]
    paths: ['.github/template.yml']

# Only run on repositories created from this template, not the template itself
jobs:
  setup:
    name: Create Setup Issue
    runs-on: ubuntu-latest
    if: github.repository != 'willgriffin/startup-gitops-template'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create setup issue
        run: |
          echo "ðŸ”§ Creating repository setup issue..."
          
          # Create issue for setup-repo.sh execution
          gh issue create \
            --title "Repository Setup Required" \
            --body "$(cat <<'EOF'
          ## ðŸš€ Repository Setup Required

          This repository was created from the GitOps template and needs to be configured.

          ### Setup Information
          The template form provided these configuration values:
          - **Domain**: ${{ vars.SETUP_REPO_DOMAIN || 'Not provided' }}
          - **Email**: ${{ vars.SETUP_REPO_EMAIL || 'Not provided' }}
          - **Cluster Name**: ${{ vars.SETUP_REPO_CLUSTER_NAME || 'Not provided' }}
          - **Region**: ${{ vars.SETUP_REPO_REGION || 'Not provided' }}
          - **Project Name**: ${{ vars.SETUP_REPO_PROJECT_NAME || 'Not provided' }}
          - **Keycloak Realm**: ${{ vars.SETUP_REPO_KEYCLOAK_REALM || 'Not provided' }}
          - **Backup Retention**: ${{ vars.SETUP_REPO_BACKUP_RETENTION || 'Not provided' }}
          - **Spaces Region**: ${{ vars.SETUP_REPO_SPACES_REGION || 'Not provided' }}

          ### Next Steps
          Run the setup script to configure this repository:

          #### Option 1: Non-Interactive (recommended)
          The setup variables are already available from the template form:
          ```bash
          ./setup-repo.sh --non-interactive
          ```

          #### Option 2: Interactive
          Prompt for values manually:
          ```bash
          ./setup-repo.sh
          ```

          ### What the setup script does:
          - Replaces template placeholders with your actual values
          - Updates all Kubernetes manifests and Terraform files
          - Creates an issue for template cleanup after completion

          @claude Please run the setup script using the non-interactive mode with the form values.
          EOF
          )"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}