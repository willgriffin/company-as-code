# Configuration Guide

This guide covers the TypeScript-based configuration system used by the enterprise GitOps template, including schema validation, environment options, and customization patterns.

## Overview

The template uses a sophisticated TypeScript-based configuration system with:

- **JSON Configuration**: Primary configuration in `platform/config.json`
- **Schema Validation**: Zod-based runtime validation with TypeScript types
- **Type Safety**: Full IntelliSense support and compile-time validation
- **Environment Support**: Multiple environment configurations (staging/production)
- **Validation**: Comprehensive validation with helpful error messages

## Configuration Structure

### Main Configuration File

The primary configuration is stored in `platform/config.json`:

```json
{
  "project": {
    "name": "my-company",
    "domain": "company.com",
    "email": "devops@company.com",
    "description": "Production GitOps infrastructure"
  },
  "environments": [
    {
      "name": "production",
      "cluster": {
        "region": "nyc3",
        "nodeSize": "s-4vcpu-8gb",
        "nodeCount": 3,
        "minNodes": 2,
        "maxNodes": 10,
        "haControlPlane": true,
        "version": "1.31.0-do.0"
      },
      "domain": "company.com"
    }
  ]
}
```

### Configuration Generation

Configuration is generated by the `setup.ts` script through:

1. **Interactive Prompts**: CLI prompts for configuration values
2. **Environment Variables**: Non-interactive setup using environment variables
3. **Validation**: Real-time validation during generation
4. **Template Processing**: Domain and name substitution in manifests

## Schema Definition

### TypeScript Types

The configuration uses Zod for runtime validation with generated TypeScript types:

```typescript
// From platform/src/config/schema.ts
export interface Config {
  project: Project;
  environments: Environment[];
}

export interface Project {
  name: string;           // lowercase, hyphens only
  domain: string;         // valid domain format
  email: string;          // valid email address
  description?: string;   // optional description
}

export interface Environment {
  name: 'staging' | 'production';
  cluster: Cluster;
  domain: string;
}

export interface Cluster {
  region: string;         // DigitalOcean region
  nodeSize: string;       // DigitalOcean droplet size
  nodeCount: number;      // number of worker nodes
  minNodes?: number;      // minimum nodes for autoscaling
  maxNodes?: number;      // maximum nodes for autoscaling
  haControlPlane: boolean; // high availability control plane
  version?: string;       // Kubernetes version
}
```

### Validation Rules

#### Project Validation
```typescript
const ProjectSchema = z.object({
  name: z.string()
    .min(1, 'Project name is required')
    .max(50, 'Project name must be 50 characters or less')
    .regex(/^[a-z0-9-]+$/, 'Project name must contain only lowercase letters, numbers, and hyphens'),
  domain: z.string()
    .min(1, 'Domain is required')
    .regex(/^[a-z0-9.-]+$/, 'Invalid domain format'),
  email: z.string().email('Valid email address is required'),
  description: z.string().optional()
});
```

#### Cluster Validation
```typescript
const ClusterSchema = z.object({
  region: z.string().min(1, 'Region is required'),
  nodeSize: z.string().min(1, 'Node size is required'),
  nodeCount: z.number().int().min(1, 'Node count must be at least 1'),
  minNodes: z.number().int().min(1).optional(),
  maxNodes: z.number().int().max(100).optional(),
  haControlPlane: z.boolean().default(false),
  version: z.string().optional()
}).refine(data => {
  // Validate that minNodes <= nodeCount <= maxNodes
  const { nodeCount, minNodes, maxNodes } = data;
  if (minNodes && minNodes > nodeCount) return false;
  if (maxNodes && maxNodes < nodeCount) return false;
  if (minNodes && maxNodes && minNodes > maxNodes) return false;
  return true;
}, {
  message: "minNodes must be <= nodeCount <= maxNodes"
});
```

## Configuration Options

### Project Settings

| Field | Type | Required | Description | Example |
|-------|------|----------|-------------|---------|
| `name` | string | ✅ | Project identifier (lowercase, hyphens) | `my-company` |
| `domain` | string | ✅ | Primary domain for applications | `company.com` |
| `email` | string | ✅ | Admin email for SSL certificates | `devops@company.com` |
| `description` | string | ❌ | Human-readable description | `Production infrastructure` |

#### Project Name Requirements
- Must be lowercase letters, numbers, and hyphens only
- No spaces or special characters
- Maximum 50 characters
- Used for resource naming across infrastructure

#### Domain Requirements
- Valid domain format (a-z, 0-9, dots, hyphens)
- Must be configured with DigitalOcean DNS
- Used for application subdomains and SSL certificates

### Environment Settings

| Field | Type | Required | Description | Options |
|-------|------|----------|-------------|---------|
| `name` | enum | ✅ | Environment identifier | `staging` \| `production` |
| `cluster` | object | ✅ | Cluster configuration | See cluster options |
| `domain` | string | ✅ | Environment-specific domain | `staging.company.com` |

### Cluster Configuration

#### Node Configuration

| Field | Type | Required | Description | Example |
|-------|------|----------|-------------|---------|
| `region` | string | ✅ | DigitalOcean region | `nyc3`, `sfo3`, `lon1` |
| `nodeSize` | string | ✅ | Droplet size for worker nodes | `s-2vcpu-4gb` |
| `nodeCount` | number | ✅ | Number of worker nodes | `3` |
| `minNodes` | number | ❌ | Minimum nodes for autoscaling | `2` |
| `maxNodes` | number | ❌ | Maximum nodes for autoscaling | `10` |

#### Available Regions
```json
{
  "regions": [
    "nyc1", "nyc3",      // New York
    "sfo2", "sfo3",      // San Francisco  
    "tor1",              // Toronto
    "lon1",              // London
    "fra1",              // Frankfurt
    "ams2", "ams3",      // Amsterdam
    "sgp1",              // Singapore
    "blr1",              // Bangalore
    "syd1"               // Sydney
  ]
}
```

#### Available Node Sizes
```json
{
  "nodeSizes": [
    "s-1vcpu-2gb",       // $12/month - Basic development
    "s-2vcpu-4gb",       // $24/month - Light production
    "s-4vcpu-8gb",       // $48/month - Standard production
    "s-8vcpu-16gb",      // $96/month - High-performance
    "c-4",               // $48/month - CPU-optimized
    "c-8",               // $96/month - CPU-optimized
    "m-4vcpu-32gb",      // $192/month - Memory-optimized
    "m-8vcpu-64gb"       // $384/month - Memory-optimized
  ]
}
```

#### Cluster Options

| Field | Type | Required | Description | Default |
|-------|------|----------|-------------|---------|
| `haControlPlane` | boolean | ❌ | High availability control plane | `false` |
| `version` | string | ❌ | Kubernetes version | Latest stable |

## Environment Variables

For CI/CD and automated deployments, configuration can be provided via environment variables:

### Core Configuration Variables

```bash
# Project configuration
export SETUP_PROJECT_NAME="my-company"
export SETUP_DOMAIN="company.com"
export SETUP_EMAIL="devops@company.com"
export SETUP_DESCRIPTION="Production infrastructure"

# Environment configuration
export SETUP_ENVIRONMENT="production"
export SETUP_REGION="nyc3"
export SETUP_NODE_SIZE="s-4vcpu-8gb"
export SETUP_NODE_COUNT="3"

# Optional autoscaling
export SETUP_MIN_NODES="2"
export SETUP_MAX_NODES="10"
export SETUP_HA_CONTROL_PLANE="true"
```

### Service Credentials

```bash
# DigitalOcean
export DIGITALOCEAN_TOKEN="dop_v1_xxxxxxxxxxxxxxxx"

# AWS (for S3 state and SES)
export AWS_ACCESS_KEY_ID="AKIAXXXXXXXXXXXXXXXX"
export AWS_SECRET_ACCESS_KEY="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
export AWS_REGION="us-east-1"

# GitHub
export GITHUB_TOKEN="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
export GITHUB_REPOSITORY="organization/repository"
```

### Setup Script Usage

```bash
# Interactive setup (default)
./setup.ts

# Non-interactive with environment variables
./setup.ts --yes --no-interactive

# Dry run to preview configuration
./setup.ts --dry-run

# Custom configuration file path
./setup.ts --config custom-config.json
```

## Configuration Loading

### Load Order Priority

The CDKTF main.ts loads configuration in this order:

1. `config.json` (current directory)
2. `config.js` (current directory)
3. `config.ts` (current directory)
4. `../config.json` (parent directory)
5. `../config.js` (parent directory)
6. `../config.ts` (parent directory)
7. `../../config.json` (grandparent directory)
8. Path from `GITOPS_CONFIG_PATH` environment variable

### Configuration Validation

```typescript
// Validation occurs at load time
function loadConfig(): Config {
  const configPaths = ['config.json', 'config.js', 'config.ts'];
  
  for (const configPath of configPaths) {
    if (existsSync(configPath)) {
      const rawConfig = JSON.parse(readFileSync(configPath, 'utf-8'));
      return validateConfig(rawConfig); // Throws on validation error
    }
  }
  
  // Fallback to example configuration
  return getExampleConfig();
}
```

## Multi-Environment Configuration

### Staging + Production Setup

```json
{
  "project": {
    "name": "my-company",
    "domain": "company.com",
    "email": "devops@company.com"
  },
  "environments": [
    {
      "name": "staging",
      "cluster": {
        "region": "nyc3",
        "nodeSize": "s-2vcpu-4gb",
        "nodeCount": 1,
        "haControlPlane": false
      },
      "domain": "staging.company.com"
    },
    {
      "name": "production",
      "cluster": {
        "region": "nyc3",
        "nodeSize": "s-4vcpu-8gb",
        "nodeCount": 3,
        "minNodes": 2,
        "maxNodes": 10,
        "haControlPlane": true
      },
      "domain": "company.com"
    }
  ]
}
```

### Environment-Specific CDKTF Stacks

Each environment creates separate CDKTF stacks:

```typescript
// Creates stacks for each environment
const clusterStacks = config.environments.map(env => {
  return new DigitalOceanClusterStack(app, `${config.project.name}-${env.name}`, {
    projectName: config.project.name,
    environment: env,
    config
  });
});
```

## Advanced Configuration

### TypeScript Configuration Files

For dynamic configuration, use TypeScript files:

```typescript
// config.ts
import { Config } from './platform/src/config/schema';

const config: Config = {
  project: {
    name: process.env.PROJECT_NAME || 'my-company',
    domain: process.env.DOMAIN || 'company.com',
    email: process.env.EMAIL || 'devops@company.com',
    description: 'Dynamically configured infrastructure'
  },
  environments: [{
    name: 'production',
    cluster: {
      region: process.env.REGION || 'nyc3',
      nodeSize: process.env.NODE_SIZE || 's-4vcpu-8gb',
      nodeCount: parseInt(process.env.NODE_COUNT || '3'),
      haControlPlane: process.env.HA_CONTROL_PLANE === 'true'
    },
    domain: process.env.DOMAIN || 'company.com'
  }]
};

export default config;
```

### Configuration Validation in CI/CD

```yaml
# .github/workflows/validate-config.yml
name: Validate Configuration
on: [push, pull_request]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'pnpm'
    
    - name: Install dependencies
      run: |
        cd platform
        pnpm install
    
    - name: Validate configuration
      run: |
        cd platform
        npx tsx -e "
          import { validateConfig } from './src/config/schema';
          import config from '../config.json';
          try {
            validateConfig(config);
            console.log('✅ Configuration is valid');
          } catch (error) {
            console.error('❌ Configuration validation failed:', error.message);
            process.exit(1);
          }
        "
```

## Common Configuration Patterns

### Development Setup
```json
{
  "project": {
    "name": "myapp-dev",
    "domain": "dev.company.com",
    "email": "dev@company.com"
  },
  "environments": [{
    "name": "staging",
    "cluster": {
      "region": "nyc3",
      "nodeSize": "s-1vcpu-2gb",
      "nodeCount": 1,
      "haControlPlane": false
    },
    "domain": "dev.company.com"
  }]
}
```

### High-Availability Production
```json
{
  "project": {
    "name": "myapp",
    "domain": "company.com",
    "email": "ops@company.com"
  },
  "environments": [{
    "name": "production",
    "cluster": {
      "region": "nyc3",
      "nodeSize": "s-8vcpu-16gb",
      "nodeCount": 5,
      "minNodes": 3,
      "maxNodes": 20,
      "haControlPlane": true,
      "version": "1.31.0-do.0"
    },
    "domain": "company.com"
  }]
}
```

### Multi-Region Setup
```json
{
  "project": {
    "name": "global-app",
    "domain": "company.com",
    "email": "ops@company.com"
  },
  "environments": [
    {
      "name": "production",
      "cluster": {
        "region": "nyc3",
        "nodeSize": "s-4vcpu-8gb",
        "nodeCount": 3,
        "haControlPlane": true
      },
      "domain": "us.company.com"
    }
  ]
}
```

## Troubleshooting

### Validation Errors

```bash
# Common validation error
Error: Project name must contain only lowercase letters, numbers, and hyphens
Solution: Change "My Company" to "my-company"

# Domain validation error  
Error: Invalid domain format
Solution: Ensure domain only contains a-z, 0-9, dots, and hyphens

# Node count validation error
Error: minNodes must be <= nodeCount <= maxNodes
Solution: Adjust minNodes (2) <= nodeCount (3) <= maxNodes (10)
```

### Configuration Loading Issues

```bash
# Configuration file not found
Error: No configuration file found, using example configuration
Solution: Run ./setup.ts to generate config.json

# Invalid JSON format
Error: Unexpected token in JSON
Solution: Validate JSON syntax using jq or JSON linter

# TypeScript compilation error
Error: Cannot find module './config/schema'
Solution: Ensure dependencies installed with pnpm install
```

This configuration system provides type-safe, validated infrastructure configuration with excellent developer experience and operational reliability.