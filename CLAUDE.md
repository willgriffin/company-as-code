# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

This is a **GitHub template repository** for deploying complete Kubernetes infrastructure on [DigitalOcean](https://digitalocean.pxf.io/3evZdB) using GitOps with Flux. It provides one-click deployment of a production-ready cluster with optional applications (Keycloak, Mattermost, Nextcloud, Mailu).

The repository follows Infrastructure as Code principles using Terraform and GitOps with Flux v2.

## Architecture & Key Components

### Infrastructure as Code (IaC)
- **CDKTF** (Terraform CDK) - TypeScript-based infrastructure provisioning with type safety
- **DigitalOcean** - Cloud platform (Kubernetes clusters, DNS, Spaces storage)
- **AWS S3** - Terraform state storage with versioning and encryption
- **Backend**: Terraform state stored in AWS S3 bucket (created by setup.ts)

### GitOps & Continuous Deployment
- **Flux v2** (v2.3.0) - GitOps operator for Kubernetes continuous deployment
- **Kustomize** - Kubernetes native configuration management with overlays
- **Git-based workflows** - Branch-based deployments from main branch

### Container Orchestration & Applications
- **Kubernetes** (v1.31.0) - Container orchestration platform
- **Applications deployed**:
  - **Nextcloud** - Cloud storage with DigitalOcean Spaces primary storage
  - **Mattermost** - Team collaboration with OIDC integration
  - **Keycloak** - Identity and access management via operator
  - **Mailu/Postal** - Email server suites with OAuth2 proxy
  - **AI Gateway** - Infrastructure for AI services

### Kubernetes Operators
- **CloudNativePG** - High-availability PostgreSQL clusters (3 replicas)
- **Redis Operator** - Distributed Redis cluster management for caching
- **Keycloak Operator** - Identity management automation with realm configuration
- **External Secrets Operator** - Dynamic secret injection from external stores

### Networking & Security
- **Kong Gateway** - Enterprise API gateway with Gateway API, OIDC, and advanced routing
- **cert-manager** - Automatic TLS certificate management with Let's Encrypt
- **External DNS** - Automatic DNS record management with DigitalOcean
- **OAuth2 Proxy** - Authentication proxy for OIDC/OAuth2 integration

### Secret Management
- **External Secrets Operator** - Dynamic secret injection from external stores
- **GitHub Secrets** - Repository secrets as external secret backend
- **AWS Secrets Manager** - Optional advanced secret backend
- **Kubernetes Native**: Secrets fetched at runtime, not stored in Git

## Tools and Technologies

### Core CLI Tools (versions in tool-versions.txt)
- **kubectl** (v1.31.0) - Kubernetes CLI
- **flux** (v2.3.0) - Flux CLI for GitOps management
- **terraform** (v1.12.1) - Infrastructure as Code (via CDKTF)
- **doctl** (v1.117.0) - DigitalOcean CLI (optional, for cluster management)
- **yq** (v4.44.3) - YAML processor
- **gomplate** (v3.11.7) - Template processor for dynamic configuration

### Development Tools & Runtime
- **Node.js** (v22+) - Required runtime for CDKTF and setup scripts
- **PNPM** - Package manager for monorepo workspace
- **TypeScript** - Primary language for infrastructure and configuration
- **CDKTF** - Terraform CDK for type-safe infrastructure as code

### Configuration Management
- **TypeScript Configuration**: `platform/config.json` with schema validation
- **Interactive Setup**: `setup.ts` script with CLI prompts and validation
- **Environment Variables**: Support for CI/CD automation
- **Tool Versions**: Centralized in `tool-versions.txt` for CI/CD caching

### CI/CD & Automation
- **GitHub Actions** - Multi-stage deployment pipelines with TypeScript
- **Custom Actions**: 
  - `setup-tools` - Installs and caches GitOps tools
  - `validate-config` - Repository configuration validation
- **CDKTF Stacks**: TypeScript-based infrastructure provisioning
- **Automated Secrets**: GitHub repository secret management via setup.ts

### Database & Storage
- **PostgreSQL** - High-availability clusters via CloudNativePG operator (3 replicas)
- **Redis** - Distributed caching and session storage via Redis operator
- **DigitalOcean Spaces** - Primary application storage (not just backup)
- **AWS S3** - Terraform state storage with versioning and encryption

## Project Structure

### Key Directories
- `/manifests/` - GitOps manifests organized by cluster (formerly `/flux/`)
- `/platform/` - CDKTF infrastructure definitions with TypeScript stacks
- `/scripts/` - Automation scripts for cluster lifecycle
- `/.github/` - CI/CD workflows and actions with custom actions
- `/docs/` - Technical documentation for architecture and deployment

### Important Files
- `platform/config.json` - Main infrastructure configuration (generated by setup.ts)
- `setup.ts` - Interactive setup script for prerequisites and authentication
- `tool-versions.txt` - Tool version definitions for CI caching
- `WORKFLOW.md` - Issue management workflow specification
- `platform/config.json.example` - Example configuration template

## Affiliate Links & External References

When referencing DigitalOcean in markdown files:
- Use [digitalocean.pxf.io/3evZdB](https://digitalocean.pxf.io/3evZdB) to link to Digital Ocean's frontpage
- Use [digitalocean.pxf.io/je2Ggv](https://digitalocean.pxf.io/je2Ggv) when linking to API tokens
- When referencing API tokens, format as: [https://cloud.digitalocean.com/account/api/tokens](https://digitalocean.pxf.io/je2Ggv)
- Include a note in each README that links to Digital Ocean are affiliate links supporting template maintenance

## Development Workflow

### Issue Management
- Follows Kanban-style workflow defined in `WORKFLOW.md`. Please refer to that file for a detailed explanation of the issue management process.

### Secret Management
- Use External Secrets Operator for dynamic secret injection
- GitHub repository secrets as primary backend
- AWS Secrets Manager for advanced secret management
- Runtime secret fetching (no secrets stored in Git)

### Deployment Process
1. Run `./setup.ts` for interactive configuration and prerequisites
2. CDKTF provisions infrastructure via TypeScript stacks
3. Flux is bootstrapped to cluster with GitHub integration
4. External Secrets Operator enables dynamic secret injection
5. Kong Gateway provides enterprise API gateway with OIDC
6. Applications deploy with automatic OIDC and secret integration

## Synchronization Rules
- `.claude/commands/issue.md` and `WORKFLOW.md` should always be reflective of each other. If a change is requested to either, it should be echo'd in the other.
- `tool-versions.txt` drives CI/CD tool caching and should be updated when tool versions change

## Automation Notes
- **Automation Philosophy**: Minimize manual intervention in infrastructure and deployment processes
- Prefer declarative, idempotent configuration over manual setup steps

## Claude's Memories
- I don't need comments on how things used to be