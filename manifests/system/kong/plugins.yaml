# Kong plugins configuration
apiVersion: configuration.konghq.com/v1
kind: KongPlugin
metadata:
  name: keycloak-oidc
  namespace: kong
spec:
  plugin: oidc
  config:
    client_id: kong-gateway
    client_secret:
      valueFrom:
        secretKeyRef:
          name: kong-secrets
          key: oidc-client-secret
    discovery: "https://auth.happyvertical.com/realms/mycompany/.well-known/openid_configuration"
    redirect_uri_scheme: https
    session_storage: redis
    session_redis_host: rfs-kong-redis.kong.svc.cluster.local
    session_redis_port: 6379
    logout_path: /logout
    revoke_tokens_on_logout: true
---
# Prometheus metrics plugin
apiVersion: configuration.konghq.com/v1
kind: KongPlugin
metadata:
  name: prometheus-metrics
  namespace: kong
spec:
  plugin: prometheus
  config:
    per_consumer: true
    status_code_metrics: true
    latency_metrics: true
    bandwidth_metrics: true
---
# Rate limiting plugin
apiVersion: configuration.konghq.com/v1
kind: KongPlugin
metadata:
  name: basic-rate-limit
  namespace: kong
spec:
  plugin: rate-limiting-advanced
  config:
    limit: [100]
    window_size: [60]
    sync_rate: 5
    strategy: redis
    redis:
      host: rfs-kong-redis.kong.svc.cluster.local
      port: 6379
---
# Request size limiting plugin
apiVersion: configuration.konghq.com/v1
kind: KongPlugin
metadata:
  name: request-size-limit
  namespace: kong
spec:
  plugin: request-size-limiting
  config:
    allowed_payload_size: 128
---
# Expense tracking plugin (custom)
apiVersion: configuration.konghq.com/v1
kind: KongPlugin
metadata:
  name: expense-tracker
  namespace: kong
spec:
  plugin: http-log
  config:
    http_endpoint: "http://expense-tracker.kong.svc.cluster.local:8080/kong-webhook"
    method: POST
    content_type: application/json
    flush_timeout: 2
    keepalive: 60000