# Redis for Kong session storage
apiVersion: redis.redis.opstreelabs.in/v1beta2
kind: Redis
metadata:
  name: kong-redis
  namespace: kong
spec:
  kubernetesConfig:
    image: redis:7-alpine
    imagePullPolicy: IfNotPresent
  storage:
    volumeClaimTemplate:
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 1Gi
  redisConfig:
    maxmemory: 512mb
    maxmemory-policy: allkeys-lru
---
# Kong Gateway configuration
apiVersion: gateway.networking.k8s.io/v1beta1
kind: Gateway
metadata:
  name: kong-gateway
  namespace: kong
spec:
  gatewayClassName: kong
  listeners:
  - name: proxy
    port: 80
    protocol: HTTP
  - name: proxy-ssl
    port: 443
    protocol: HTTPS
    tls:
      mode: Terminate
      certificateRefs:
      - kind: Secret
        name: wildcard-tls
---
# Kong secrets managed by External Secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: kong-secrets
  namespace: kong
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: cluster-secret-store
    kind: ClusterSecretStore
  target:
    name: kong-secrets
    creationPolicy: Owner
  data:
  - secretKey: oidc-client-secret
    remoteRef:
      key: credentials
      property: kong-oidc-client-secret