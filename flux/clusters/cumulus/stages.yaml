# Staged deployment of infrastructure and applications
# Each stage depends on the previous one being ready

# Stage 1: Core infrastructure (cert-manager, traefik)
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: core
  namespace: flux-system
spec:
  interval: 10m
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./flux/clusters/cumulus/core
  prune: true
  wait: true
  timeout: 5m

---
# Stage 2: Controllers (database operators, keycloak operator)
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: controllers
  namespace: flux-system
spec:
  dependsOn:
    - name: core
  interval: 10m
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./flux/clusters/cumulus/controllers
  prune: true
  wait: true
  timeout: 5m

---
# Stage 3: Services (keycloak instance)
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: services
  namespace: flux-system
spec:
  dependsOn:
    - name: controllers
  interval: 10m
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./flux/clusters/cumulus/services
  prune: true
  wait: true
  timeout: 10m

---
# Stage 4: Applications (nextcloud, mattermost, mailu)
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: applications
  namespace: flux-system
spec:
  dependsOn:
    - name: services
  interval: 10m
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./flux/clusters/cumulus/applications
  prune: true
  wait: true
  timeout: 10m