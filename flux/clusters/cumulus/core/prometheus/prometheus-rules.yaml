# PrometheusRule for application-specific alerts
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: application-alerts
  namespace: prometheus
  labels:
    app: prometheus
spec:
  groups:
  - name: application.rules
    interval: 30s
    rules:
    # Nextcloud alerts
    - alert: NextcloudDown
      expr: up{job="nextcloud-metrics"} == 0
      for: 5m
      labels:
        severity: critical
        service: nextcloud
      annotations:
        summary: "Nextcloud is down"
        description: "Nextcloud has been down for more than 5 minutes"
    
    - alert: NextcloudHighErrorRate
      expr: rate(nextcloud_database_queries_total{status="error"}[5m]) > 0.1
      for: 2m
      labels:
        severity: warning
        service: nextcloud
      annotations:
        summary: "High error rate in Nextcloud"
        description: "Nextcloud error rate is {{ $value }} errors per second"
    
    # Mattermost alerts
    - alert: MattermostDown
      expr: up{job="mattermost-metrics"} == 0
      for: 5m
      labels:
        severity: critical
        service: mattermost
      annotations:
        summary: "Mattermost is down"
        description: "Mattermost has been down for more than 5 minutes"
    
    # Sentry alerts
    - alert: SentryDown
      expr: up{job="sentry-metrics"} == 0
      for: 5m
      labels:
        severity: critical
        service: sentry
      annotations:
        summary: "Sentry is down"
        description: "Sentry has been down for more than 5 minutes"
    
    # Database alerts
    - alert: PostgreSQLDown
      expr: up{job="postgresql-metrics"} == 0
      for: 5m
      labels:
        severity: critical
        service: postgresql
      annotations:
        summary: "PostgreSQL cluster is down"
        description: "PostgreSQL cluster {{ $labels.cluster }} has been down for more than 5 minutes"
    
    - alert: PostgreSQLHighConnections
      expr: pg_stat_database_numbackends / pg_settings_max_connections * 100 > 80
      for: 5m
      labels:
        severity: warning
        service: postgresql
      annotations:
        summary: "PostgreSQL high connection usage"
        description: "PostgreSQL connection usage is at {{ $value }}%"
    
    # Redis alerts
    - alert: RedisDown
      expr: up{job="redis-metrics"} == 0
      for: 5m
      labels:
        severity: critical
        service: redis
      annotations:
        summary: "Redis is down"
        description: "Redis instance {{ $labels.instance }} has been down for more than 5 minutes"
    
    - alert: RedisHighMemoryUsage
      expr: redis_memory_used_bytes / redis_memory_max_bytes * 100 > 90
      for: 5m
      labels:
        severity: warning
        service: redis
      annotations:
        summary: "Redis high memory usage"
        description: "Redis memory usage is at {{ $value }}%"