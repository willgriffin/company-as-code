apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: kong-gateway
  namespace: kong-system
spec:
  interval: 30m
  chart:
    spec:
      chart: kong
      version: "2.38.0"
      sourceRef:
        kind: HelmRepository
        name: kong
        namespace: kong-system
  values:
    # Deployment configuration
    deployment:
      kong:
        enabled: true
      
    # Gateway configuration 
    gateway:
      enabled: true
      type: LoadBalancer
      annotations:
        service.beta.kubernetes.io/do-loadbalancer-name: "kong-gateway"
        service.beta.kubernetes.io/do-loadbalancer-protocol: "http"
        service.beta.kubernetes.io/do-loadbalancer-algorithm: "round_robin"
        service.beta.kubernetes.io/do-loadbalancer-size-slug: "lb-small"
        service.beta.kubernetes.io/do-loadbalancer-enable-proxy-protocol: "true"
    
    # Admin API configuration
    admin:
      enabled: true
      type: ClusterIP
      http:
        enabled: true
        servicePort: 8001
        containerPort: 8001
      tls:
        enabled: false
    
    # Manager UI configuration
    manager:
      enabled: true
      type: ClusterIP
      http:
        enabled: true
        servicePort: 8002
        containerPort: 8002
      tls:
        enabled: false
    
    # Ingress controller
    ingressController:
      enabled: true
      installCRDs: true
      
      # Gateway API support
      gatewayDiscovery:
        enabled: true
        
      # Environment variables
      env:
        kong_admin_listen: "0.0.0.0:8001"
        kong_admin_gui_listen: "0.0.0.0:8002"
        kong_database: "postgres"
        kong_pg_host: "kong-postgres-rw.kong-system.svc.cluster.local"
        kong_pg_port: "5432"
        kong_pg_database: "kong"
        kong_pg_user: "kong"
        kong_plugins: "bundled,oidc,prometheus,opentelemetry,ai-proxy,rate-limiting-advanced"
        
      # Use external PostgreSQL
      secretVolumes:
      - kong-postgres-credentials
      
    # PostgreSQL configuration (use external)
    postgresql:
      enabled: false
      
    # Resources
    resources:
      requests:
        cpu: 500m
        memory: 1Gi
      limits:
        cpu: 2000m
        memory: 2Gi
        
    # Auto-scaling
    autoscaling:
      enabled: true
      minReplicas: 2
      maxReplicas: 5
      targetCPUUtilizationPercentage: 80
      
    # Health checks
    readinessProbe:
      httpGet:
        path: "/status"
        port: 8100
        scheme: HTTP
      initialDelaySeconds: 5
      timeoutSeconds: 5
      periodSeconds: 10
      
    livenessProbe:
      httpGet:
        path: "/status"
        port: 8100
        scheme: HTTP
      initialDelaySeconds: 5
      timeoutSeconds: 5
      periodSeconds: 10
      failureThreshold: 3
      
    # Security context
    securityContext:
      runAsUser: 1000
      runAsGroup: 1000
      fsGroup: 1000
      
    # Service account
    serviceAccount:
      create: true
      
    # Proxy configuration
    proxy:
      enabled: true
      type: LoadBalancer
      annotations:
        service.beta.kubernetes.io/do-loadbalancer-name: "kong-proxy"
        service.beta.kubernetes.io/do-loadbalancer-protocol: "http"
        service.beta.kubernetes.io/do-loadbalancer-algorithm: "round_robin"
        service.beta.kubernetes.io/do-loadbalancer-size-slug: "lb-small"
        external-dns.alpha.kubernetes.io/hostname: "api.{{ (datasource \"config\").domain }}"
      http:
        enabled: true
        servicePort: 80
        containerPort: 8000
      tls:
        enabled: true
        servicePort: 443
        containerPort: 8443