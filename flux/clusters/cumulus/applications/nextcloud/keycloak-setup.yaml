apiVersion: v1
kind: ConfigMap
metadata:
  name: nextcloud-keycloak-setup
  namespace: nextcloud
data:
  instructions: |
    Keycloak Setup Instructions for Nextcloud Integration
    =====================================================
    
    1. Access Keycloak admin console at https://auth.happyvertical.com
    
    2. Create a new client for Nextcloud in the "happyvertical" realm:
       - Client ID: nextcloud
       - Client Protocol: openid-connect
       - Access Type: confidential
       - Valid Redirect URIs: 
         - https://cloud.happyvertical.com/*
       - Web Origins: https://cloud.happyvertical.com
       - Backchannel Logout URL: https://cloud.happyvertical.com/apps/oidc_login/oidc
    
    3. Configure client scopes:
       - Default Client Scopes: openid, email, profile, roles
    
    4. Add protocol mappers:
       - Groups mapper (if not exists):
         * Name: groups
         * Mapper Type: Group Membership
         * Token Claim Name: groups
         * Full group path: OFF
         * Add to ID token: ON
         * Add to access token: ON
         * Add to userinfo: ON
    
    5. Get the client secret from the Credentials tab
    
    6. Update the nextcloud-oidc secret with the actual client secret:
       kubectl edit secret nextcloud-oidc -n nextcloud
    
    7. Configure realm settings:
       - Set "Frontend URL" to https://auth.happyvertical.com if not already set
       - This ensures correct issuer URL in tokens
    
    8. Create groups in Keycloak (optional):
       - Groups created in Keycloak will sync to Nextcloud
       - Example: admin, users, managers
    
    9. User provisioning:
       - Users will be auto-created in Nextcloud on first login
       - Email addresses are used as the primary identifier
       - Groups are synchronized from Keycloak
    
    Note: The OIDC app is automatically installed and configured
    via the startup script. Users can use both local Nextcloud
    accounts and Keycloak SSO.