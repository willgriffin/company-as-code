apiVersion: v1
kind: Secret
metadata:
  name: postal-rabbitmq-admin
  namespace: postal
type: Opaque
stringData:
  username: "postal-admin"
  password: "${POSTAL_RABBITMQ_PASSWORD}"
---
apiVersion: rabbitmq.com/v1beta1
kind: User
metadata:
  name: postal-admin
  namespace: postal
spec:
  rabbitmqClusterReference:
    name: postal-rabbitmq
  importCredentialsSecret:
    name: postal-rabbitmq-admin
  tags:
  - administrator
---
apiVersion: rabbitmq.com/v1beta1
kind: Permission
metadata:
  name: postal-admin-permission
  namespace: postal
spec:
  vhost: "/"
  user: "postal-admin"
  permissions:
    configure: ".*"
    write: ".*"
    read: ".*"
  rabbitmqClusterReference:
    name: postal-rabbitmq
---
apiVersion: rabbitmq.com/v1beta1
kind: Vhost
metadata:
  name: postal-vhost
  namespace: postal
spec:
  name: "postal"
  rabbitmqClusterReference:
    name: postal-rabbitmq
---
apiVersion: rabbitmq.com/v1beta1
kind: Queue
metadata:
  name: postal-mail-queue
  namespace: postal
spec:
  name: "mail.processing"
  vhost: "postal"
  type: "quorum"
  durable: true
  arguments:
    x-queue-type: quorum
    x-max-length: 10000
    x-message-ttl: 86400000  # 24 hours
  rabbitmqClusterReference:
    name: postal-rabbitmq
---
apiVersion: rabbitmq.com/v1beta1
kind: Exchange
metadata:
  name: postal-mail-exchange
  namespace: postal
spec:
  name: "mail.exchange"
  type: "direct"
  durable: true
  vhost: "postal"
  rabbitmqClusterReference:
    name: postal-rabbitmq
---
apiVersion: rabbitmq.com/v1beta1
kind: Binding
metadata:
  name: postal-mail-binding
  namespace: postal
spec:
  source: "mail.exchange"
  destination: "mail.processing"
  destinationType: "queue"
  routingKey: "mail.inbound"
  vhost: "postal"
  rabbitmqClusterReference:
    name: postal-rabbitmq