apiVersion: rabbitmq.com/v1beta1
kind: RabbitmqCluster
metadata:
  name: postal-rabbitmq
  namespace: postal
spec:
  replicas: 3
  
  # Resource configuration
  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 1Gi
  
  # Storage configuration
  persistence:
    storageClassName: do-block-storage
    storage: 10Gi
  
  # RabbitMQ configuration
  rabbitmq:
    additionalConfig: |
      # Memory and disk thresholds
      vm_memory_high_watermark.relative = 0.8
      disk_free_limit.relative = 0.1
      
      # Queue configuration
      queue_master_locator = min-masters
      
      # Clustering
      cluster_formation.peer_discovery_backend = rabbit_peer_discovery_k8s
      cluster_formation.k8s.host = kubernetes.default.svc.cluster.local
      cluster_formation.k8s.address_type = hostname
      cluster_formation.node_cleanup.interval = 30
      cluster_formation.node_cleanup.only_log_warning = true
      
      # Management plugin
      management.tcp.port = 15672
      management.tcp.ip = 0.0.0.0
      
      # Enable plugins
      enabled_plugins = [rabbitmq_management,rabbitmq_peer_discovery_k8s,rabbitmq_prometheus].
    
    # Advanced configuration
    advancedConfig: |
      [
        {rabbit, [
          {log_levels, [{connection, info}, {channel, info}]},
          {heartbeat, 600},
          {frame_max, 131072}
        ]},
        {rabbitmq_management, [
          {rates_mode, basic}
        ]}
      ].
  
  # Service configuration
  service:
    type: ClusterIP
    annotations:
      service.beta.kubernetes.io/aws-load-balancer-type: nlb
  
  # Override default image if needed
  image: rabbitmq:3.13-management
  
  # Security context
  securityContext:
    fsGroup: 999
    runAsUser: 999
    runAsGroup: 999
  
  # Affinity rules for high availability
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: postal-rabbitmq
          topologyKey: kubernetes.io/hostname