apiVersion: v1
kind: ConfigMap
metadata:
  name: keycloak-setup-instructions
  namespace: mailu
data:
  instructions: |
    Keycloak Setup Instructions for Mailu Integration
    =================================================
    
    1. Access Keycloak admin console at https://auth.happyvertical.com
    
    2. Create a new realm called "happyvertical" (or use existing)
    
    3. Create a new client for Mailu:
       - Client ID: mailu
       - Client Protocol: openid-connect
       - Access Type: confidential
       - Valid Redirect URIs: 
         - https://mail.happyvertical.com/oauth2/callback
         - https://mail.happyvertical.com/*
       - Web Origins: https://mail.happyvertical.com
    
    4. Configure client scopes:
       - Default Client Scopes: email, profile, roles
    
    5. Get the client secret from the Credentials tab
    
    6. Update the oauth2-proxy secret with the actual client secret:
       kubectl edit secret oauth2-proxy -n mailu
    
    7. Create user attributes mapping (optional):
       - Add mapper for groups
       - Add mapper for email verified
    
    8. Configure Mailu to accept OAuth headers:
       - The oauth2-proxy passes authenticated user info in headers
       - Mailu admin can be configured to trust these headers
    
    9. Create users in Keycloak:
       - Users created in Keycloak will be able to access webmail
       - Email addresses must match the Mailu domain
    
    Note: For full email functionality, users still need to be created 
    in Mailu with matching email addresses. The OAuth integration 
    primarily handles authentication for the web interfaces.