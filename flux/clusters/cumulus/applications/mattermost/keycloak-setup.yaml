apiVersion: v1
kind: ConfigMap
metadata:
  name: mattermost-keycloak-setup
  namespace: mattermost
data:
  instructions: |
    Keycloak Setup Instructions for Mattermost Integration
    ======================================================
    
    1. Access Keycloak admin console at https://auth.happyvertical.com
    
    2. Create a new client for Mattermost in the "happyvertical" realm:
       - Client ID: mattermost
       - Client Protocol: openid-connect
       - Access Type: confidential
       - Valid Redirect URIs: 
         - https://chat.happyvertical.com/signup/gitlab/complete
         - https://chat.happyvertical.com/login/gitlab/complete
       - Web Origins: https://chat.happyvertical.com
    
    3. Configure client scopes:
       - Default Client Scopes: openid, email, profile
    
    4. Add protocol mappers:
       - Username mapper (if not exists):
         * Name: username
         * Mapper Type: User Property
         * Property: username
         * Token Claim Name: preferred_username
         * Add to ID token: ON
         * Add to access token: ON
         * Add to userinfo: ON
    
    5. Get the client secret from the Credentials tab
    
    6. Update the mattermost-oauth secret with the actual client secret:
       kubectl edit secret mattermost-oauth -n mattermost
    
    7. Configure user defaults in Keycloak:
       - Ensure users have email addresses
       - Users will be auto-created in Mattermost on first login
    
    Note: Mattermost uses the GitLab OAuth provider settings to connect
    to any OpenID Connect provider, including Keycloak.