apiVersion: v1
kind: ConfigMap
metadata:
  name: sentry-keycloak-setup
  namespace: sentry
data:
  instructions: |
    Keycloak Setup Instructions for Sentry Integration
    =================================================
    
    1. Access Keycloak admin console at https://auth.{{ (datasource "config").domain.primary }}
    
    2. Create a new client for Sentry in the "happyvertical" realm:
       - Client ID: sentry
       - Client Protocol: openid-connect
       - Access Type: confidential
       - Valid Redirect URIs: 
         - https://sentry.{{ (datasource "config").domain.primary }}/oauth2/callback
       - Web Origins: https://sentry.{{ (datasource "config").domain.primary }}
    
    3. Configure client scopes:
       - Default Client Scopes: openid, email, profile
    
    4. Get the client secret from the Credentials tab
    
    5. Update the sentry-oauth2-proxy secret with the actual client secret:
       kubectl edit secret sentry-oauth2-proxy -n sentry
    
    6. Generate a 32-character random cookie secret:
       openssl rand -base64 32 | head -c 32
       Update the cookie-secret in the same secret
    
    7. Configure Sentry SSO (after Sentry is deployed):
       - Go to Settings > Auth in Sentry admin
       - Add Generic OAuth2 provider with:
         * Authorization URL: https://auth.{{ (datasource "config").domain.primary }}/realms/happyvertical/protocol/openid-connect/auth
         * Token URL: https://auth.{{ (datasource "config").domain.primary }}/realms/happyvertical/protocol/openid-connect/token
         * Client ID: sentry
         * Client Secret: [from Keycloak]
    
    Note: OAuth2 Proxy handles external authentication, while Sentry can also
    be configured for direct SSO integration for team management.