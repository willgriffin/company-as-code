apiVersion: v1
kind: ConfigMap
metadata:
  name: nextcloud-oidc-config
  namespace: nextcloud
data:
  oidc-config.sh: |
    #!/bin/sh
    set -eu
    
    # Wait for Nextcloud to be fully installed
    until su -s /bin/sh www-data -c "php /var/www/html/occ status" | grep -q "installed: true"; do
      echo "Waiting for Nextcloud installation..."
      sleep 10
    done
    
    echo "Configuring OIDC for Keycloak integration..."
    
    # Install and enable the OIDC app
    su -s /bin/sh www-data -c "php /var/www/html/occ app:install oidc_login || true"
    su -s /bin/sh www-data -c "php /var/www/html/occ app:enable oidc_login"
    
    # Configure OIDC settings
    su -s /bin/sh www-data -c "php /var/www/html/occ config:system:set oidc_login_provider_url --value='https://auth.happyvertical.com/realms/happyvertical'"
    su -s /bin/sh www-data -c "php /var/www/html/occ config:system:set oidc_login_client_id --value='nextcloud'"
    su -s /bin/sh www-data -c "php /var/www/html/occ config:system:set oidc_login_client_secret --value='${OIDC_CLIENT_SECRET:-changeme-configure-in-keycloak}'"
    su -s /bin/sh www-data -c "php /var/www/html/occ config:system:set oidc_login_auto_redirect --value=false --type=boolean"
    su -s /bin/sh www-data -c "php /var/www/html/occ config:system:set oidc_login_logout_url --value='https://auth.happyvertical.com/realms/happyvertical/protocol/openid-connect/logout?post_logout_redirect_uri=https%3A%2F%2Fcloud.happyvertical.com%2F'"
    su -s /bin/sh www-data -c "php /var/www/html/occ config:system:set oidc_login_button_text --value='Login with Keycloak'"
    su -s /bin/sh www-data -c "php /var/www/html/occ config:system:set oidc_login_code_challenge_method --value='S256'"
    su -s /bin/sh www-data -c "php /var/www/html/occ config:system:set oidc_login_attributes id --value='preferred_username'"
    su -s /bin/sh www-data -c "php /var/www/html/occ config:system:set oidc_login_attributes name --value='name'"
    su -s /bin/sh www-data -c "php /var/www/html/occ config:system:set oidc_login_attributes mail --value='email'"
    su -s /bin/sh www-data -c "php /var/www/html/occ config:system:set oidc_login_attributes groups --value='groups'"
    su -s /bin/sh www-data -c "php /var/www/html/occ config:system:set oidc_login_default_group --value='users'"
    su -s /bin/sh www-data -c "php /var/www/html/occ config:system:set oidc_login_create_groups --value=true --type=boolean"
    
    # Configure user backend
    su -s /bin/sh www-data -c "php /var/www/html/occ config:system:set oidc_login_disable_registration --value=false --type=boolean"
    su -s /bin/sh www-data -c "php /var/www/html/occ config:system:set oidc_login_redir_fallback --value=true --type=boolean"
    
    echo "OIDC configuration completed"