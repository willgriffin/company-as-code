apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: mailu
  namespace: mailu
spec:
  interval: 30m
  chart:
    spec:
      chart: mailu
      version: "1.5.0"
      sourceRef:
        kind: HelmRepository
        name: mailu
        namespace: mailu
  values:
    # Main mail domain
    domain: happyvertical.com
    
    # Initial admin account
    initialAccount:
      enabled: true
      username: admin
      domain: happyvertical.com
      password: changeme-in-production
    
    # Hostnames
    hostnames:
      - mail.happyvertical.com
    
    # Use external ingress
    ingress:
      enabled: false  # We'll use Traefik IngressRoute instead
    
    # Front (nginx proxy) configuration
    front:
      image:
        repository: mailu/nginx
        tag: 2.0
      resources:
        requests:
          memory: 100Mi
          cpu: 50m
        limits:
          memory: 200Mi
          cpu: 200m
    
    # Admin interface
    admin:
      image:
        repository: mailu/admin
        tag: 2.0
      resources:
        requests:
          memory: 256Mi
          cpu: 100m
        limits:
          memory: 512Mi
          cpu: 500m
    
    # Webmail (Roundcube)
    roundcube:
      enabled: true
      image:
        repository: mailu/roundcube
        tag: 2.0
      resources:
        requests:
          memory: 128Mi
          cpu: 50m
        limits:
          memory: 256Mi
          cpu: 200m
    
    # IMAP server (Dovecot)
    dovecot:
      image:
        repository: mailu/dovecot
        tag: 2.0
      resources:
        requests:
          memory: 256Mi
          cpu: 100m
        limits:
          memory: 512Mi
          cpu: 500m
    
    # SMTP server (Postfix)
    postfix:
      image:
        repository: mailu/postfix
        tag: 2.0
      resources:
        requests:
          memory: 256Mi
          cpu: 100m
        limits:
          memory: 512Mi
          cpu: 500m
    
    # Antispam (Rspamd)
    rspamd:
      image:
        repository: mailu/rspamd
        tag: 2.0
      resources:
        requests:
          memory: 256Mi
          cpu: 100m
        limits:
          memory: 512Mi
          cpu: 500m
    
    # Antivirus (ClamAV) - disabled by default due to resource usage
    clamav:
      enabled: false
    
    # Webdav
    webdav:
      enabled: false
    
    # Fetchmail
    fetchmail:
      enabled: false
    
    # Storage
    persistence:
      size: 100Gi
      storageClass: do-block-storage
      
    # Redis
    redis:
      image:
        repository: redis
        tag: 7-alpine
      resources:
        requests:
          memory: 64Mi
          cpu: 25m
        limits:
          memory: 128Mi
          cpu: 100m
    
    # PostgreSQL for Mailu database
    database:
      type: postgresql
      postgresql:
        image:
          repository: postgres
          tag: 15-alpine
        auth:
          database: mailu
          username: mailu
          password: changeme-in-production
        persistence:
          size: 10Gi
        resources:
          requests:
            memory: 128Mi
            cpu: 50m
          limits:
            memory: 256Mi
            cpu: 200m
    
    # Security settings
    subnet: "10.244.0.0/16"  # Kubernetes pod network
    
    # Features
    auth_ratelimit_ip: "5/hour"
    auth_ratelimit_user: "50/day"
    
    # External authentication - will be configured via ConfigMap
    # to integrate with Keycloak