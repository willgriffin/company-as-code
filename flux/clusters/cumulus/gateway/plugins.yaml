# Kong plugins for DB-less mode with Keycloak OIDC and expense tracking

---
# OIDC plugin for Keycloak authentication (DB-less compatible)
apiVersion: configuration.konghq.com/v1
kind: KongClusterPlugin
metadata:
  name: keycloak-oidc
config:
  issuer: https://auth.{{ (datasource "config").domain }}/realms/master
  client_id: kong-gateway
  client_secret: "changeme-will-be-replaced-by-secret"
  discovery: https://auth.{{ (datasource "config").domain }}/realms/master/.well-known/openid-configuration
  scope: openid profile email
  redirect_uri: /auth/callback
  logout_uri_suffix: /auth/logout
  post_logout_redirect_uri: https://auth.{{ (datasource "config").domain }}
  # Use Redis for session storage in DB-less mode
  session_storage: redis
  session_redis_host: rfs-kong-redis.kong-system.svc.cluster.local
  session_redis_port: 6379
  session_cookie_secure: true
  session_cookie_httponly: true
  bearer_only: false
  realm: master
plugin: openid-connect

---
# Prometheus metrics plugin (per-service)
apiVersion: configuration.konghq.com/v1
kind: KongClusterPlugin
metadata:
  name: prometheus-metrics
config:
  per_consumer: false
  status_code_metrics: true
  latency_metrics: true
  bandwidth_metrics: true
  upstream_health_metrics: true
plugin: prometheus

---
# OpenTelemetry tracing plugin (per-service)
apiVersion: configuration.konghq.com/v1
kind: KongClusterPlugin
metadata:
  name: opentelemetry-tracing
config:
  endpoint: http://opentelemetry-collector.opentelemetry-operator-system.svc.cluster.local:4318/v1/traces
  headers:
    x-service-name: kong-gateway
  resource_attributes:
    service.name: kong-gateway
    service.version: "3.0"
  batch_span_processor:
    max_queue_size: 2048
    batch_timeout: 1
    max_batch_size: 256
plugin: opentelemetry

---
# Basic rate limiting plugin (local, no Redis dependency)
apiVersion: configuration.konghq.com/v1
kind: KongClusterPlugin
metadata:
  name: basic-rate-limit
config:
  minute: 1000
  hour: 10000
  day: 100000
  limit_by: ip
  policy: local
  hide_client_headers: false
plugin: rate-limiting

---
# Request size limiting plugin
apiVersion: configuration.konghq.com/v1
kind: KongClusterPlugin
metadata:
  name: request-size-limit
config:
  allowed_payload_size: 128
  size_unit: megabytes
  require_content_length: false
plugin: request-size-limiting

---
# Custom expense tracking plugin for LiteLLM integration
apiVersion: configuration.konghq.com/v1
kind: KongClusterPlugin
metadata:
  name: expense-tracker
config:
  # Track requests and responses for billing
  log_payloads: false
  log_headers: true
  expense_service_url: http://expense-tracker.kong-system.svc.cluster.local:8080
  # Headers to extract for billing
  track_headers:
    - x-user-id
    - x-organization-id
    - authorization
  # Expense calculation
  rate_per_request: 0.001  # Base rate per API call
  webhook_timeout: 1000    # ms
plugin: http-log