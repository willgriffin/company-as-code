# Application deployments with granular dependencies
# Each application declares only its actual dependencies

---
# Mattermost - Team Chat
{{ if (datasource "config").services.mattermost.enabled }}
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: mattermost
  namespace: flux-system
spec:
  dependsOn:
    - name: traefik              # Needs ingress
    - name: cert-manager-post-deploy  # Needs TLS certificates
    - name: cloudnativepg        # Needs PostgreSQL
    - name: keycloak            # Needs identity provider
  interval: 10m
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./flux/clusters/cumulus/applications/mattermost
  prune: true
  wait: true
  timeout: 10m
  decryption:
    provider: sops
    secretRef:
      name: sops-age

---
{{ end }}
# Nextcloud - Cloud Storage
{{ if (datasource "config").services.nextcloud.enabled }}
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: nextcloud
  namespace: flux-system
spec:
  dependsOn:
    - name: traefik              # Needs ingress
    - name: cert-manager-post-deploy  # Needs TLS certificates
    - name: cloudnativepg        # Needs PostgreSQL
    - name: redis-operator       # Needs Redis for caching
    - name: keycloak            # Needs identity provider for OIDC
  interval: 10m
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./flux/clusters/cumulus/applications/nextcloud
  prune: true
  wait: true
  timeout: 10m
  decryption:
    provider: sops
    secretRef:
      name: sops-age

---
{{ end }}

---
# Mailu - Email Server
{{ if (datasource "config").services.mailu.enabled }}
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: mailu
  namespace: flux-system
spec:
  dependsOn:
    - name: traefik              # Needs ingress
    - name: cert-manager-post-deploy  # Needs TLS certificates
    - name: cloudnativepg        # Needs PostgreSQL operator
    - name: redis-operator       # Needs Redis operator
    - name: keycloak            # Needs identity provider for OAuth
  interval: 10m
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./flux/clusters/cumulus/applications/mailu
  prune: true
  wait: true
  timeout: 10m
  decryption:
    provider: sops
    secretRef:
      name: sops-age

---
{{ end }}
# Sentry - Error Tracking
{{ if (datasource "config").monitoring.sentry.enabled }}
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: sentry
  namespace: flux-system
spec:
  dependsOn:
    - name: traefik              # Needs ingress
    - name: cert-manager-post-deploy  # Needs TLS certificates
    - name: cloudnativepg        # Needs PostgreSQL operator
    - name: redis-operator       # Needs Redis operator
    - name: keycloak            # Needs identity provider for OAuth
    - name: sentry-operator      # Needs Sentry operator
  interval: 10m
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./flux/clusters/cumulus/applications/sentry
  prune: true
  wait: true
  timeout: 10m
  decryption:
    provider: sops
    secretRef:
      name: sops-age
{{ end }}